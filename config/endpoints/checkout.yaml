# Checkout Flow — Stateful Scenario Example
#
# State machine:
#
#   idle ──(POST /cart)──► cart_ready
#                              │
#                   (POST /payment)
#                              │
#                              ▼
#                    payment_processing
#                              │
#                   (POST /confirm)
#                              │
#                              ▼
#                          confirmed
#
# GET /status is read-only — returns the current step without advancing it.
# Any out-of-order call returns 409.
#
# State is partitioned by the X-Session-ID header, so each session
# (i.e. each user) progresses independently.

endpoints:

  # ── Step 1: Create Cart ────────────────────────────────────────────────────
  - path: "/api/v1/checkout/cart"
    method: "POST"
    description: "Create a checkout cart (idle → cart_ready)"
    scenario: "checkout_flow"
    scenario_key: "session_id"
    selectors:
      - name: "session_id"
        type: "header"
        key: "X-Session-ID"
    rules:
      - scenario_step: "idle"
        conditions: []
        next_step: "cart_ready"
        response_file: "./mocks/checkout/cart_created.json"
        status_code: 201
        template:
          enabled: true
      - scenario_step: "any"
        conditions: []
        response_file: "./mocks/checkout/invalid_state.json"
        status_code: 409
    default:
      response_file: "./mocks/checkout/invalid_state.json"
      status_code: 409

  # ── Step 2: Submit Payment ─────────────────────────────────────────────────
  - path: "/api/v1/checkout/payment"
    method: "POST"
    description: "Submit payment info (cart_ready → payment_processing)"
    scenario: "checkout_flow"
    scenario_key: "session_id"
    selectors:
      - name: "session_id"
        type: "header"
        key: "X-Session-ID"
    rules:
      - scenario_step: "cart_ready"
        conditions: []
        next_step: "payment_processing"
        response_file: "./mocks/checkout/payment_processing.json"
        status_code: 200
        template:
          enabled: true
      - scenario_step: "any"
        conditions: []
        response_file: "./mocks/checkout/invalid_state.json"
        status_code: 409
    default:
      response_file: "./mocks/checkout/invalid_state.json"
      status_code: 409

  # ── Step 3: Confirm Order ──────────────────────────────────────────────────
  - path: "/api/v1/checkout/confirm"
    method: "POST"
    description: "Confirm the order (payment_processing → confirmed)"
    scenario: "checkout_flow"
    scenario_key: "session_id"
    selectors:
      - name: "session_id"
        type: "header"
        key: "X-Session-ID"
    rules:
      - scenario_step: "payment_processing"
        conditions: []
        next_step: "confirmed"
        response_file: "./mocks/checkout/confirmed.json"
        status_code: 200
        template:
          enabled: true
      - scenario_step: "any"
        conditions: []
        response_file: "./mocks/checkout/invalid_state.json"
        status_code: 409
    default:
      response_file: "./mocks/checkout/invalid_state.json"
      status_code: 409

  # ── Read-only: Get Status ──────────────────────────────────────────────────
  - path: "/api/v1/checkout/status"
    method: "GET"
    description: "Get current checkout state (read-only, no step transition)"
    scenario: "checkout_flow"
    scenario_key: "session_id"
    selectors:
      - name: "session_id"
        type: "header"
        key: "X-Session-ID"
    rules:
      - scenario_step: "idle"
        conditions: []
        response_file: "./mocks/checkout/status_idle.json"
        status_code: 200
        template:
          enabled: true
      - scenario_step: "cart_ready"
        conditions: []
        response_file: "./mocks/checkout/status_cart_ready.json"
        status_code: 200
        template:
          enabled: true
      - scenario_step: "payment_processing"
        conditions: []
        response_file: "./mocks/checkout/status_payment_processing.json"
        status_code: 200
        template:
          enabled: true
      - scenario_step: "confirmed"
        conditions: []
        response_file: "./mocks/checkout/status_confirmed.json"
        status_code: 200
        template:
          enabled: true
    default:
      response_file: "./mocks/checkout/status_idle.json"
      status_code: 200
      template:
        enabled: true
