<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mock API Server Dashboard</title>
  <script src="./vendor/tailwind.cdn.js"></script>
  <script defer src="./vendor/alpine.min.js"></script>
  <style>
    [x-cloak] { display: none !important; }
    pre { white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen" x-data="dashboard()" x-init="init()" x-cloak>

  <!-- Header -->
  <header class="bg-indigo-700 text-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold">Mock API Server Dashboard</h1>
      <span class="text-sm opacity-75" x-text="'Uptime: ' + uptimeStr"></span>
    </div>
  </header>

  <!-- Tab Bar -->
  <nav class="bg-white border-b shadow-sm">
    <div class="max-w-7xl mx-auto px-4 flex space-x-2">
      <template x-for="tab in tabs" :key="tab">
        <button
          @click="switchTab(tab)"
          :class="activeTab === tab
            ? 'border-b-2 border-indigo-600 text-indigo-600 font-semibold'
            : 'text-gray-500 hover:text-gray-700'"
          class="px-4 py-3 text-sm capitalize transition-colors"
          x-text="tab">
        </button>
      </template>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 py-6">

    <!-- ===== ENDPOINTS TAB ===== -->
    <div x-show="activeTab === 'endpoints'">
      <div class="flex justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-800">Registered Endpoints</h2>
        <button @click="fetchEndpoints()" class="text-sm text-indigo-600 hover:underline">Refresh</button>
      </div>
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Source</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Method</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Path</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Description</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Rules</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="(ep, idx) in endpoints" :key="ep.index + ep.source + idx">
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">
                  <span :class="ep.source === 'runtime' ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'"
                    class="px-2 py-0.5 rounded text-xs font-medium" x-text="ep.source"></span>
                </td>
                <td class="px-4 py-2">
                  <span :class="methodColor(ep.endpoint.method)"
                    class="px-2 py-0.5 rounded text-xs font-bold" x-text="ep.endpoint.method"></span>
                </td>
                <td class="px-4 py-2 font-mono text-gray-800" x-text="ep.endpoint.path"></td>
                <td class="px-4 py-2 text-gray-500" x-text="ep.endpoint.description || '—'"></td>
                <td class="px-4 py-2 text-gray-500" x-text="(ep.endpoint.rules || []).length"></td>
                <td class="px-4 py-2">
                  <button @click="expandedEndpoint = (expandedEndpoint === idx ? null : idx)"
                    class="text-xs text-indigo-600 hover:underline"
                    x-text="expandedEndpoint === idx ? 'Collapse' : 'Detail'"></button>
                </td>
              </tr>
              <!-- Expandable detail row -->
              <tr x-show="expandedEndpoint === idx" class="bg-indigo-50">
                <td colspan="6" class="px-4 py-3">
                  <div class="grid grid-cols-2 gap-4 text-xs">
                    <div>
                      <p class="font-medium text-gray-600 mb-1">Selectors</p>
                      <pre class="bg-white p-2 rounded border text-gray-700 max-h-32 overflow-auto" x-text="JSON.stringify(ep.endpoint.selectors || [], null, 2)"></pre>
                    </div>
                    <div>
                      <p class="font-medium text-gray-600 mb-1">Rules</p>
                      <pre class="bg-white p-2 rounded border text-gray-700 max-h-32 overflow-auto" x-text="JSON.stringify(ep.endpoint.rules || [], null, 2)"></pre>
                    </div>
                    <div>
                      <p class="font-medium text-gray-600 mb-1">Default Response</p>
                      <pre class="bg-white p-2 rounded border text-gray-700 max-h-32 overflow-auto" x-text="JSON.stringify(ep.endpoint.default || {}, null, 2)"></pre>
                    </div>
                    <div x-show="ep.endpoint.scenario">
                      <p class="font-medium text-gray-600 mb-1">Scenario</p>
                      <pre class="bg-white p-2 rounded border text-gray-700" x-text="ep.endpoint.scenario + (ep.endpoint.scenario_key ? ' (key: ' + ep.endpoint.scenario_key + ')' : '')"></pre>
                    </div>
                  </div>
                </td>
              </tr>
            </template>
            <tr x-show="endpoints.length === 0">
              <td colspan="6" class="px-4 py-6 text-center text-gray-400">No endpoints loaded</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== REQUESTS TAB ===== -->
    <div x-show="activeTab === 'requests'">
      <div class="flex justify-between mb-3 items-center">
        <h2 class="text-lg font-semibold text-gray-800">Request History
          <span class="ml-2 text-sm text-gray-400" x-text="'(' + filteredRequests.length + ' shown / ' + requestsTotal + ' total)'"></span>
        </h2>
        <div class="flex gap-2">
          <button @click="fetchRequests()" class="text-sm text-indigo-600 hover:underline">Refresh</button>
          <button @click="clearRequests()" class="text-sm text-red-600 hover:underline">Clear All</button>
        </div>
      </div>

      <!-- Filter bar -->
      <div class="bg-white rounded shadow p-3 mb-3 flex flex-wrap gap-3 items-center">
        <div class="flex items-center gap-1.5">
          <label class="text-xs text-gray-500 font-medium">Method</label>
          <select x-model="reqFilter.method" class="text-xs border rounded px-2 py-1 text-gray-700">
            <option value="">All</option>
            <option>GET</option><option>POST</option><option>PUT</option>
            <option>PATCH</option><option>DELETE</option><option>OPTIONS</option>
          </select>
        </div>
        <div class="flex items-center gap-1.5">
          <label class="text-xs text-gray-500 font-medium">Status</label>
          <select x-model="reqFilter.status" class="text-xs border rounded px-2 py-1 text-gray-700">
            <option value="">All</option>
            <option value="2">2xx</option>
            <option value="3">3xx</option>
            <option value="4">4xx</option>
            <option value="5">5xx</option>
          </select>
        </div>
        <div class="flex items-center gap-1.5 flex-1 min-w-[180px]">
          <label class="text-xs text-gray-500 font-medium">Path</label>
          <input x-model="reqFilter.path" type="text" placeholder="filter path…"
            class="text-xs border rounded px-2 py-1 text-gray-700 flex-1" />
        </div>
        <button @click="reqFilter = { method: '', status: '', path: '' }"
          class="text-xs text-gray-400 hover:text-gray-600">Clear filters</button>
      </div>

      <div class="bg-white rounded shadow overflow-x-auto mb-3">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Time</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Method</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Path</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Status</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Duration</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Matched Rule</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium"></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="req in filteredRequests" :key="req.id">
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 text-gray-500 whitespace-nowrap" x-text="formatTime(req.timestamp)"></td>
                <td class="px-4 py-2">
                  <span :class="methodColor(req.method)"
                    class="px-2 py-0.5 rounded text-xs font-bold" x-text="req.method"></span>
                </td>
                <td class="px-4 py-2 font-mono text-gray-800 max-w-xs">
                  <span class="block truncate" :title="req.path + (req.query ? '?' + req.query : '')" x-text="req.path + (req.query ? '?' + req.query : '')"></span>
                </td>
                <td class="px-4 py-2">
                  <span :class="statusColor(req.response_status)"
                    class="px-2 py-0.5 rounded text-xs font-bold" x-text="req.response_status"></span>
                </td>
                <td class="px-4 py-2 text-gray-500" x-text="req.duration_ms + 'ms'"></td>
                <td class="px-4 py-2 text-gray-400 text-xs" x-text="req.matched_rule || '—'"></td>
                <td class="px-4 py-2">
                  <button @click="inspectRequest(req)" class="text-xs text-indigo-600 hover:underline">Inspect</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredRequests.length === 0">
              <td colspan="7" class="px-4 py-6 text-center text-gray-400">No requests recorded</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Load more -->
      <div class="flex justify-center" x-show="requests.length < requestsTotal">
        <button @click="loadMoreRequests()"
          class="text-sm text-indigo-600 border border-indigo-200 rounded px-4 py-1.5 hover:bg-indigo-50">
          Load more (showing <span x-text="requests.length"></span> of <span x-text="requestsTotal"></span>)
        </button>
      </div>
    </div>

    <!-- ===== SCENARIOS TAB ===== -->
    <div x-show="activeTab === 'scenarios'">
      <div class="flex justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-800">Active Scenarios</h2>
        <button @click="fetchScenarios()" class="text-sm text-indigo-600 hover:underline">Refresh</button>
      </div>
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Scenario</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Partition Key</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Current Step</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="sc in scenarios" :key="sc.scenario + sc.partition_key">
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2 font-mono text-gray-800" x-text="sc.scenario"></td>
                <td class="px-4 py-2 text-gray-500" x-text="sc.partition_key || '(global)'"></td>
                <td class="px-4 py-2">
                  <span class="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded text-xs font-medium" x-text="sc.current_step"></span>
                </td>
                <td class="px-4 py-2 flex gap-3">
                  <button @click="resetScenarioPartition(sc.scenario, sc.partition_key)"
                    class="text-xs text-orange-600 hover:underline">Reset this</button>
                  <button @click="resetScenario(sc.scenario)"
                    class="text-xs text-red-600 hover:underline">Reset all</button>
                </td>
              </tr>
            </template>
            <tr x-show="scenarios.length === 0">
              <td colspan="4" class="px-4 py-6 text-center text-gray-400">No active scenarios</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== METRICS TAB ===== -->
    <div x-show="activeTab === 'metrics'">
      <div class="flex justify-between mb-3">
        <h2 class="text-lg font-semibold text-gray-800">Endpoint Metrics</h2>
        <button @click="fetchMetrics()" class="text-sm text-indigo-600 hover:underline">Refresh</button>
      </div>
      <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Method</th>
              <th class="px-4 py-2 text-left text-gray-500 font-medium">Path</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Requests</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Errors</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Error Rate</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Avg ms</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">P95 ms</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">P99 ms</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Min ms</th>
              <th class="px-4 py-2 text-right text-gray-500 font-medium">Max ms</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            <template x-for="m in metricsData" :key="m.method + m.path">
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-2">
                  <span :class="methodColor(m.method)"
                    class="px-2 py-0.5 rounded text-xs font-bold" x-text="m.method"></span>
                </td>
                <td class="px-4 py-2 font-mono text-gray-800" x-text="m.path"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.request_count"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.error_count"></td>
                <td class="px-4 py-2 text-right" :class="m.error_count > 0 ? 'text-red-600' : 'text-green-600'"
                  x-text="m.request_count > 0 ? ((m.error_count / m.request_count) * 100).toFixed(1) + '%' : '0%'"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.avg_ms.toFixed(1)"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.p95_ms"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.p99_ms"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.min_ms"></td>
                <td class="px-4 py-2 text-right text-gray-700" x-text="m.max_ms"></td>
              </tr>
            </template>
            <tr x-show="metricsData.length === 0">
              <td colspan="10" class="px-4 py-6 text-center text-gray-400">No metrics data yet</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== CONFIG TAB ===== -->
    <div x-show="activeTab === 'config'">
      <div class="flex justify-between mb-3 items-center">
        <h2 class="text-lg font-semibold text-gray-800">Current Configuration</h2>
        <div class="flex gap-2">
          <button @click="fetchConfig()" class="text-sm text-indigo-600 hover:underline">Refresh</button>
          <button @click="copyText(configJson)" class="text-sm text-gray-500 hover:underline">Copy</button>
          <button @click="triggerReload()" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">Trigger Reload</button>
        </div>
      </div>
      <div x-show="reloadMsg" class="mb-3 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-700" x-text="reloadMsg"></div>
      <div class="bg-white rounded shadow p-4">
        <pre class="text-xs overflow-auto max-h-[70vh]" x-html="highlightJson(configJson)"></pre>
      </div>
    </div>

  </main>

  <!-- ===== REQUEST INSPECT MODAL ===== -->
  <div
    x-show="showModal"
    x-transition:enter="transition ease-out duration-150"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-100"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"
    @click.self="showModal = false; selectedRequest = null"
    @keydown.escape.window="showModal = false; selectedRequest = null">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center px-5 py-3 border-b">
        <div>
          <h3 class="font-semibold text-gray-700">Request Detail</h3>
          <p class="font-mono text-xs text-gray-400 mt-0.5" x-text="selectedRequest && (selectedRequest.method + ' ' + selectedRequest.path + (selectedRequest.query ? '?' + selectedRequest.query : ''))"></p>
        </div>
        <button @click="showModal = false; selectedRequest = null" class="text-gray-400 hover:text-gray-600 text-2xl leading-none">&times;</button>
      </div>
      <div class="overflow-auto p-5 grid grid-cols-2 gap-4 flex-1">
        <div>
          <div class="flex justify-between items-center mb-1">
            <p class="text-xs font-medium text-gray-500">Request Headers</p>
            <button @click="copyText(JSON.stringify(selectedRequest && selectedRequest.request_headers, null, 2))" class="text-xs text-gray-400 hover:text-indigo-600">Copy</button>
          </div>
          <pre class="bg-gray-50 p-2 rounded text-xs text-gray-700 max-h-48 overflow-auto" x-text="JSON.stringify(selectedRequest && selectedRequest.request_headers, null, 2)"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <p class="text-xs font-medium text-gray-500">Response Headers</p>
            <button @click="copyText(JSON.stringify(selectedRequest && selectedRequest.response_headers, null, 2))" class="text-xs text-gray-400 hover:text-indigo-600">Copy</button>
          </div>
          <pre class="bg-gray-50 p-2 rounded text-xs text-gray-700 max-h-48 overflow-auto" x-text="JSON.stringify(selectedRequest && selectedRequest.response_headers, null, 2)"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <p class="text-xs font-medium text-gray-500">Request Body</p>
            <button @click="copyText(selectedRequest && selectedRequest.request_body)" class="text-xs text-gray-400 hover:text-indigo-600">Copy</button>
          </div>
          <pre class="bg-gray-50 p-2 rounded text-xs text-gray-700 max-h-56 overflow-auto" x-text="selectedRequest && (selectedRequest.request_body || '(empty)')"></pre>
        </div>
        <div>
          <div class="flex justify-between items-center mb-1">
            <p class="text-xs font-medium text-gray-500">Response Body</p>
            <button @click="copyText(selectedRequest && selectedRequest.response_body)" class="text-xs text-gray-400 hover:text-indigo-600">Copy</button>
          </div>
          <pre class="bg-gray-50 p-2 rounded text-xs text-gray-700 max-h-56 overflow-auto" x-text="selectedRequest && (selectedRequest.response_body || '(empty)')"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Detect admin prefix from current URL path
    function getAdminBase() {
      const path = window.location.pathname;
      return path.replace(/\/ui\/?.*$/, '');
    }

    function dashboard() {
      const base = getAdminBase();
      return {
        tabs: ['endpoints', 'requests', 'scenarios', 'metrics', 'config'],
        activeTab: 'endpoints',
        endpoints: [],
        expandedEndpoint: null,
        requests: [],
        requestsTotal: 0,
        requestsOffset: 0,
        requestsLimit: 50,
        reqFilter: { method: '', status: '', path: '' },
        selectedRequest: null,
        showModal: false,
        scenarios: [],
        metricsData: [],
        uptimeStr: '—',
        configJson: '',
        reloadMsg: '',

        get filteredRequests() {
          return this.requests.filter(r => {
            if (this.reqFilter.method && r.method !== this.reqFilter.method) return false;
            if (this.reqFilter.status) {
              const d = parseInt(this.reqFilter.status);
              const s = r.response_status;
              if (d === 2 && (s < 200 || s >= 300)) return false;
              if (d === 3 && (s < 300 || s >= 400)) return false;
              if (d === 4 && (s < 400 || s >= 500)) return false;
              if (d === 5 && s < 500) return false;
            }
            if (this.reqFilter.path && !r.path.toLowerCase().includes(this.reqFilter.path.toLowerCase())) return false;
            return true;
          });
        },

        async init() {
          await this.fetchAll();
          setInterval(() => this.fetchHealth(), 10000);
          setInterval(() => {
            if (this.activeTab === 'requests') this.fetchRequests();
            else if (this.activeTab === 'scenarios') this.fetchScenarios();
            else if (this.activeTab === 'metrics') this.fetchMetrics();
          }, 5000);
        },

        switchTab(tab) {
          this.activeTab = tab;
          if (tab === 'requests') this.fetchRequests();
          else if (tab === 'endpoints') this.fetchEndpoints();
          else if (tab === 'scenarios') this.fetchScenarios();
          else if (tab === 'metrics') this.fetchMetrics();
          else if (tab === 'config') this.fetchConfig();
        },

        async fetchAll() {
          await Promise.all([
            this.fetchEndpoints(),
            this.fetchRequests(),
            this.fetchScenarios(),
            this.fetchMetrics(),
            this.fetchConfig(),
            this.fetchHealth(),
          ]);
        },

        async fetchHealth() {
          try {
            const r = await fetch(`${base}/health`);
            const d = await r.json();
            const secs = Math.round(d.uptime_sec || 0);
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            const s = secs % 60;
            this.uptimeStr = `${h}h ${m}m ${s}s`;
          } catch {}
        },

        async fetchEndpoints() {
          try {
            const r = await fetch(`${base}/endpoints`);
            const d = await r.json();
            this.endpoints = d.endpoints || [];
          } catch {}
        },

        async fetchRequests() {
          try {
            const r = await fetch(`${base}/requests?limit=${this.requestsLimit}&offset=0`);
            const d = await r.json();
            this.requests = d.requests || [];
            this.requestsTotal = d.total || 0;
            this.requestsOffset = this.requests.length;
          } catch {}
        },

        async loadMoreRequests() {
          try {
            const r = await fetch(`${base}/requests?limit=${this.requestsLimit}&offset=${this.requestsOffset}`);
            const d = await r.json();
            const more = d.requests || [];
            this.requests = [...this.requests, ...more];
            this.requestsTotal = d.total || this.requestsTotal;
            this.requestsOffset = this.requests.length;
          } catch {}
        },

        async clearRequests() {
          try {
            await fetch(`${base}/requests`, { method: 'DELETE' });
            this.requests = [];
            this.requestsTotal = 0;
            this.requestsOffset = 0;
            this.selectedRequest = null;
          } catch {}
        },

        async inspectRequest(req) {
          try {
            const r = await fetch(`${base}/requests/${req.id}`);
            this.selectedRequest = await r.json();
          } catch {
            this.selectedRequest = req;
          }
          this.showModal = true;
        },

        async fetchScenarios() {
          try {
            const r = await fetch(`${base}/scenarios`);
            const d = await r.json();
            this.scenarios = d.scenarios || [];
          } catch {}
        },

        async resetScenario(name) {
          try {
            await fetch(`${base}/scenarios/${encodeURIComponent(name)}/reset`, { method: 'POST' });
            await this.fetchScenarios();
          } catch {}
        },

        async resetScenarioPartition(name, partitionKey) {
          try {
            const qs = partitionKey ? `?partition_key=${encodeURIComponent(partitionKey)}` : '';
            await fetch(`${base}/scenarios/${encodeURIComponent(name)}/reset${qs}`, { method: 'POST' });
            await this.fetchScenarios();
          } catch {}
        },

        async fetchMetrics() {
          try {
            const r = await fetch(`${base}/metrics`);
            const d = await r.json();
            this.metricsData = d.endpoints || [];
          } catch {}
        },

        async fetchConfig() {
          try {
            const r = await fetch(`${base}/config`);
            const d = await r.json();
            this.configJson = JSON.stringify(d, null, 2);
          } catch {}
        },

        async triggerReload() {
          try {
            const r = await fetch(`${base}/config/reload`, { method: 'POST' });
            const d = await r.json();
            this.reloadMsg = d.message || 'Reloaded';
            await this.fetchConfig();
            await this.fetchEndpoints();
            setTimeout(() => this.reloadMsg = '', 4000);
          } catch (e) {
            this.reloadMsg = 'Reload failed: ' + e.message;
          }
        },

        async copyText(text) {
          if (!text) return;
          try { await navigator.clipboard.writeText(text); } catch {}
        },

        // Simple JSON syntax highlighter — output is safe: all user content is HTML-escaped first.
        highlightJson(json) {
          if (!json) return '';
          const escaped = json
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
          return escaped.replace(
            /("(?:\\u[0-9a-fA-F]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(?:true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
            match => {
              let cls = 'text-purple-600';
              if (/^"/.test(match)) {
                cls = /:$/.test(match) ? 'text-blue-700 font-medium' : 'text-green-700';
              } else if (/true|false/.test(match)) {
                cls = 'text-indigo-500';
              } else if (match === 'null') {
                cls = 'text-red-400';
              }
              return `<span class="${cls}">${match}</span>`;
            }
          );
        },

        formatTime(ts) {
          if (!ts) return '—';
          const d = new Date(ts);
          const date = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
          const time = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
          return `${date} ${time}`;
        },

        methodColor(method) {
          const m = (method || '').toUpperCase();
          const map = {
            GET: 'bg-green-100 text-green-800',
            POST: 'bg-blue-100 text-blue-800',
            PUT: 'bg-yellow-100 text-yellow-800',
            PATCH: 'bg-orange-100 text-orange-800',
            DELETE: 'bg-red-100 text-red-800',
            OPTIONS: 'bg-gray-100 text-gray-700',
          };
          return map[m] || 'bg-gray-100 text-gray-700';
        },

        statusColor(status) {
          if (status >= 500) return 'bg-red-100 text-red-800';
          if (status >= 400) return 'bg-orange-100 text-orange-800';
          if (status >= 300) return 'bg-yellow-100 text-yellow-800';
          return 'bg-green-100 text-green-800';
        },
      };
    }
  </script>
</body>
</html>
